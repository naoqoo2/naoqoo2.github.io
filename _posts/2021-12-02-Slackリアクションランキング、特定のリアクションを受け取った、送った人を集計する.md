---
title: "Slackãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ç‰¹å®šã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å—ã‘å–ã£ãŸã€é€ã£ãŸäººã‚’é›†è¨ˆã™ã‚‹"
categories:
  - blog
tags:
  - GAS
  - Slack

---

ã‚„ã£ã¦ãã¾ã—ãŸï¼12æœˆï¼ã¨ã„ãˆã°ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã™ã­ï¼  
ä»Šå¹´ã‚‚æœ€å¾Œã¾ã§æ¥½ã—ã¿ã¾ã—ã‚‡ã†ï¼  
  
ã“ã‚Œã¯ [æ ªå¼ä¼šç¤¾ãƒã‚¤ãƒ›ãƒ  Advent Calendar 2021](https://qiita.com/advent-calendar/2021/myhm)  1æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚  
  
## ã¯ã˜ã‚ã«  
  
1å¹´ã‚’æŒ¯ã‚Šè¿”ã‚‹ã«ã¯Slackãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã‹ãªã„ã§ã—ã‚‡ã†ï¼  
ã¨ã„ã†ã“ã¨ã§ã‚‚ã†ä½•ç•ªç…ã˜ã‹ã‚ã‹ã‚‰ãªã„Slackã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆï¼  
ã”ã«ã‚‡ã”ã«ã‚‡å®Ÿè£…ã—ãŸã®ã§æŠ•ç¨¿ã—ã¾ã™ã€‚  
  
â€»ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å¤§ã„ã«å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼  
https://qiita.com/ryosuk/items/1a18c663884d2748d4ca  
  
## ãªãœã‚„ã‚‹ã‹  
  
ã‚ˆãä½¿ã‚ã‚ŒãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’çŸ¥ã‚‹ã“ã¨ã§ã€ä¼šç¤¾ã®ç‰¹è‰²ã‚„ã©ã‚“ãªä¸€å¹´ã ã£ãŸã‹ãŒã‚ã‹ã‚‹ã®ã§ã¯ï¼ŸğŸ˜ƒ  
  
ã¾ãŸã€å¼Šç¤¾ã¯MVVã®VALUE  
  
- User First  
- Profesional  
- Love  
- Playful  
  
ã¨ã„ã†4ã¤ã®ã‚«ã‚¹ã‚¿ãƒ çµµæ–‡å­—ãŒã‚ã‚Šã€  
ãã‚Œã‚’ä½¿ã£ãŸäººã€å—ã‘å–ã£ãŸäººã‚’çŸ¥ã‚‹ã“ã¨ã§  
MVVã‚’ä½“ç¾ã—ã¦ã„ã‚‹äººãŒã‚ã‹ã£ã¡ã‚ƒã†ã®ã§ã¯ï¼ï¼ŸğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒ  
  
## ã§ãã‚‹ã“ã¨  
  
ä¸‹è¨˜ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å‡ºåŠ›ã—ã¾ã™ã€‚  
â€»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆã€ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯é›†è¨ˆå¯¾è±¡å¤–ã€‚  
  
- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°  
- MVVãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å—ã‘å–ã£ãŸå›æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼‰  
- MVVãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ãŸå›æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼‰  
  
## å®Ÿè¡Œæ–¹æ³•  
### Slack App ã‚’ä½œæˆã— User OAuth Token ã‚’å–å¾—ã™ã‚‹  
  
Slack APIã‚’å©ããŸã‚ã«å¿…è¦ã€‚  
  
ãƒ¡ãƒ¢ï¼šscopesã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚°ã‚°ã‚‹ã¨æ˜”ã¯GUIä¸Šã§è¨­å®šã§ããŸã£ã½ã„ãŒä»Šã¯Manifestã‚’ç›´æ¥æ›¸ã‘ã€ã¿ãŸã„ã«è¨€ã‚ã‚Œã‚‹ã®ã§ç›´æ¥æ›¸ã„ãŸã€‚  
  
```
oauth_config:
  scopes:
    user:
      - channels:read
      - groups:read
      - im:read
      - mpim:read
      - channels:history
      - groups:history
      - im:history
      - mpim:history
      - users:read
```

### ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç”¨æ„ã™ã‚‹  
  
ä¸‹è¨˜ï¼“ã¤ã®ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚  
  
- ranking  
- mvv_get  
- mvv_send  
  
### GASã‚’å®Ÿè¡Œã™ã‚‹  
  
ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦ã€ãƒãƒ£ãƒãƒ£ã£ã¨æ›¸ãæ›ãˆã¦ã€main()ã‚’å®Ÿè¡Œï¼  
  
```js
// å‚è€ƒ: https://qiita.com/ryosuk/items/1a18c663884d2748d4ca
var API_TOKEN = "ã“ã“ã«å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒš";

var target_year = '2021'; // å¯¾è±¡å¹´
var mvv_reactions = ['ã‚‰ã¶','ã·ã‚','ã‚†ãƒ¼ã–ãƒ¼','ã·ã‚Œã„']; // MVVã®çµµæ–‡å­—å

var sheet_name_ranking = 'ranking';
var sheet_name_mvv_get = 'mvv_get';
var sheet_name_mvv_send = 'mvv_send';

// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
var MAX_HISTORY_PAGINATION = 1; // ãƒ‡ãƒãƒƒã‚°ç”¨ã®å®šæ•°ã«ãªã£ãŸ
var HISTORY_COUNT_PER_PAGE = 200; // å¯¾è±¡å¹´åˆ†ã¨ã£ã¦ãã‚‹ã€‚

var stamps = {};
var counts = [];
var ss = SpreadsheetApp.getActiveSpreadsheet();
var timezone = ss.getSpreadsheetTimeZone();

var slack_members = {};
var mvv_get_user = {};
var mvv_send_user = {};

function main() {
  var logger = new SlackChannelHistoryLogger();
  logger.run();

  updateRankingSheet();
  updateMvvGetSheet();
  updateMvvSendSheet();

  Logger.log(mvv_get_user);
  Logger.log(mvv_send_user);
  Logger.log(slack_members);

  function updateRankingSheet() {
    var sheet = ss.getSheetByName(sheet_name_ranking);
    if (!sheet) {
      sheet = ss.insertSheet().setName(sheet_name_ranking);
    }
    sheet.clear();

    var names = Object.keys(stamps);
    var ary = [];
    for (var i=0; i<names.length; i++) {
      ary.push([names[i]]);
    }
    sheet.getRange(1,1,ary.length,1).setValues(ary);
    for (var i=0; i<names.length; i++) {
      counts.push([stamps[names[i]]]); 
    }
    sheet.getRange(1,2,counts.length,1).setValues(counts);
    //é™é †ã§ã‚½ãƒ¼ãƒˆ
    sheet.getRange(1,1,counts.length,2).sort({column: 2, ascending: false});
  }

  function updateMvvGetSheet() {
    var sheet = ss.getSheetByName(sheet_name_mvv_get);
    if (!sheet) {
      sheet = ss.insertSheet().setName(sheet_name_mvv_get);
    }
    sheet.clear();

    var data = [];
    data.push(['ãªã¾ãˆ', ...mvv_reactions, 'åˆè¨ˆ']);
    Object.entries(mvv_get_user).forEach(function([key, value]){
      var name = slack_members[key];
      if (!name) {
        return;
      }
      var tmp = Object.values(value);
      var total = tmp.reduce(function(sum, element){
        return sum + element;
      }, 0);
      data.push([name, ...tmp, total]);
    });
    sheet.getRange(1,1,data.length,6).setValues(data);

    //é™é †ã§ã‚½ãƒ¼ãƒˆ
    sheet.getRange(1,1,data.length,6).sort({column: 6, ascending: false});
  }

  function updateMvvSendSheet() {
    var sheet = ss.getSheetByName(sheet_name_mvv_send);
    if (!sheet) {
      sheet = ss.insertSheet().setName(sheet_name_mvv_send);
    }
    sheet.clear();

    var data = [];
    data.push(['ãªã¾ãˆ', 'é€ä¿¡å›æ•°']);
    Object.entries(mvv_send_user).forEach(function([key, value]){
      data.push([slack_members[key], value]);
    });
    sheet.getRange(1,1,data.length,2).setValues(data);

    //é™é †ã§ã‚½ãƒ¼ãƒˆ
    sheet.getRange(1,1,data.length,2).sort({column: 2, ascending: false});
  }
};

var SlackChannelHistoryLogger = (function () {
    function SlackChannelHistoryLogger() {
        this.memberNames = {};
    }
    SlackChannelHistoryLogger.prototype.requestSlackAPI = function (path, params) {
        if (params === void 0) { params = {}; }
        var url = "https://slack.com/api/" + path + "?";
        var qparams = [];
        for (var k in params) {
            qparams.push(encodeURIComponent(k) + "=" + encodeURIComponent(params[k]));
        }
        url += qparams.join('&');
        try{
          var headers = {
            'Authorization': 'Bearer '+ API_TOKEN
          };
          var options = {
            'headers': headers
          };
          var resp = UrlFetchApp.fetch(url, options);
          var data = JSON.parse(resp.getContentText());
          if (data.error) {
            throw "GET " + path + ": " + data.error;
          }
          return data;
        }catch(e){
          return "err";
          }
    };
    SlackChannelHistoryLogger.prototype.run = function () {
        var _this = this;
        var usersResp = this.requestSlackAPI('users.list');
        for (const member of usersResp.members) {
          // //å‰Šé™¤æ¸ˆã€botãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Slackbotã‚’é™¤ã
          // if (!member.deleted && !member.is_bot && member.id !== "USLACKBOT") {
            slack_members[member.id] = member.profile.display_name;
          // }
        }

        var channelsResp = this.requestSlackAPI('conversations.list');
        for (var _i = 0, _a = channelsResp.channels; _i < _a.length; _i++) {
            var ch = _a[_i];
            this.importChannelHistoryDelta(ch);
        }

    };  
    SlackChannelHistoryLogger.prototype.importChannelHistoryDelta = function (ch) {
        var _this = this;
        var now = new Date();
        // ãƒãƒ£ãƒ³ãƒãƒ«çµã£ã¦é–‹ç™ºç”¨
        // if (ch.name != 'hogehoge') {
        //   return;
        // }
        var messages = this.loadMessagesBulk(ch, {});
        var dateStringToMessages = {};


      if(messages != "err"){
        Logger.log(ch.name + ' messages:' + messages.length);
        messages.forEach(function (msg) {
          var date = new Date(+msg.ts * 1000);
          var reactions = msg.reactions ? msg.reactions : "";
          var m_year = Utilities.formatDate(date, timezone, 'yyyy');
          // ãƒãƒ£ãƒ³ãƒãƒ«çµã£ã¦é–‹ç™ºç”¨
          // if (ch.name == 'hogehoge') {
          //   // Logger.log(Utilities.formatDate(date, timezone, 'yyyy-MM-dd'));
          //   // Logger.log(msg);
          //   // Logger.log(reactions);
          // }
          if(reactions !== "" && m_year == target_year){
            reactions.forEach(function (reaction) {
              var name = reaction.name;
              if (stamps[name]) {
                stamps[name] = stamps[name] + reaction.count;
              } else {
                stamps[name] = reaction.count;
              }

              // MVVãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã‚‰ã•ã‚‰ã«ã”ã«ã‚‡ã”ã«ã‚‡
              if (mvv_reactions.includes(name)) {
                if (!mvv_get_user[msg.user]) {
                  mvv_get_user[msg.user] = {};
                  mvv_reactions.forEach(function (mvv_reaction) {
                    mvv_get_user[msg.user][mvv_reaction] = 0;
                  });
                }
                mvv_get_user[msg.user][name] = mvv_get_user[msg.user][name] + reaction.count;

                reaction.users.forEach(function (send_user) {
                  if (!mvv_send_user[send_user]) {
                    mvv_send_user[send_user] = 0;
                  }
                  mvv_send_user[send_user]++;
                });
              }
            });
          }
        });
      }
    };
    
    SlackChannelHistoryLogger.prototype.loadMessagesBulk = function (ch, options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        var messages = [];
        options['limit'] = HISTORY_COUNT_PER_PAGE;
        options['channel'] = ch.id;
        var loadSince = function (cursor) {
          if (cursor) {
              options['cursor'] = cursor;
          }
          var resp = _this.requestSlackAPI('conversations.history', options);
          if(resp != "err"){
            messages = resp.messages.concat(messages);
          }
          return resp;
        };
        var resp = loadSince();
        var page = 1;
        // ãƒ†ã‚¹ãƒˆç”¨ã€å–å¾—æ•°çµã£ã¦ã‚„ã‚‹
        // while (resp.has_more && page <= MAX_HISTORY_PAGINATION) {
        // ãƒšãƒ¼ã‚¸ãŒã‚ã£ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¯¾è±¡å¹´ãªã‚‰æ¬¡ãƒšãƒ¼ã‚¸ã‚’å–å¾—
        // HACK: æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§åˆ¤å®šã—ã¦ã‚‹é–¢ä¿‚ã§ç„¡é§„ã«1å›å¤šãå©ã„ã¦ã‚‹ã‘ã©
        while (resp.has_more && target_year == Utilities.formatDate(new Date(+resp.messages[resp.messages.length-1].ts * 1000), timezone, 'yyyy')) {          
            resp = loadSince(resp.response_metadata.next_cursor);
            page++;
        }
        return messages;
    };
    return SlackChannelHistoryLogger;
})();

```

## ã§ãã‚ãŒã‚Š  
  
### rankingï¼ˆåˆ©ç”¨é »åº¦ã®å¤šã„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰  
![image.png](/assets/images/20211202/07b8a1ec-5b17-5dad-b56d-d6d37871c25f.png)  
  
### mvv_getï¼ˆMVVãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å—ã‘å–ã£ãŸäººï¼‰  
![image.png](/assets/images/20211202/1911a497-0fb0-5052-738a-3a02586b33c6.png)  
  
### mvv_sendï¼ˆMVVãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ãŸäººï¼‰  
![image.png](/assets/images/20211202/dc3b1efb-124f-e6cc-1257-59e2f601c897.png)  
  
## ã•ã„ã”ã«  
  
é›†è¨ˆã£ã¦æ¥½ã—ãã¦ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¾ã™ã‚ˆã­â™ª  
ãã‚Œã§ã¯ã¿ãªã•ã‚“ã€MVVã‚’æ„è­˜ã—ã¦ä»•äº‹ã—ã¦ã„ãã¾ã—ã‚‡ãƒ¼ï¼  
